workflow:
  rules:
    - if: $CI_MERGE_REQUEST_ID
    - if: $CI_COMMIT_BRANCH == "main"
    - when: never

stages:
  - verify
  - analyze
  - test
  - quality

.flutter_job:
  image: ghcr.io/cirruslabs/flutter:3.35.0
  stage: analyze
  variables:
    LC_ALL: "en_US.UTF-8"
    LANG: "en_US.UTF-8"
    PUB_CACHE: "$CI_PROJECT_DIR/.pub-cache"
  before_script:
    - flutter --version
    - flutter pub get
  cache:
    key: "$CI_JOB_NAME"
    paths:
      - .pub-cache/
      - build/

semantic_check:
  stage: verify
  image: python:3.11-slim
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "schedule" || $CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "pipeline"'
    - if: "$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS"
      when: never
    - if: "$CI_COMMIT_BRANCH"
    - if: "$CI_COMMIT_TAG"
  script:
    - python - <<'PY'
import os
import re
import sys

title = os.environ.get("CI_MERGE_REQUEST_TITLE") or os.environ.get("CI_COMMIT_TITLE") or ""
pattern = r"^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\([\w\-/]+\))?!?: .+"

if not title:
    print("Unable to determine title for semantic validation.")
    sys.exit(1)

if re.match(pattern, title):
    print(f"Semantic title check passed for: {title!r}")
    sys.exit(0)

print("Semantic title check failed.")
print("Expected a Conventional Commit title, e.g. 'feat(core): add new feature'.")
print(f"Found title: {title!r}")
sys.exit(1)
PY

flutter_analyze:
  extends: .flutter_job
  stage: analyze
  script:
    - dart format --output=none --set-exit-if-changed lib test
    - flutter analyze

flutter_test:
  extends: .flutter_job
  stage: test
  script:
    - flutter test --coverage
  artifacts:
    when: always
    paths:
      - coverage/

spell_check:
  stage: quality
  image: python:3.11-slim
  rules:
    - if: $CI_MERGE_REQUEST_ID
    - if: $CI_COMMIT_BRANCH == "main"
    - when: never
  before_script:
    - pip install --no-cache-dir codespell==2.3.0
  script:
    - |
      set -eo pipefail
      if find . -name "*.md" -print -quit | grep -q .; then
        find . -name "*.md" -print0 | xargs -0 codespell --quiet-level=2
      else
        echo "No markdown files found. Skipping spell check."
      fi
